<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨è‡ªåŠ¨åšå®¢ç”Ÿæˆå™¨</title>
    <style>
        :root { --primary: #4a90e2; --bg: #f4f4f9; }
        body { font-family: sans-serif; background: var(--bg); display: flex; height: 100vh; margin: 0; }
        .container { display: flex; width: 100%; }
        .panel { padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .left { flex: 6; background: white; border-right: 1px solid #ddd; }
        .right { flex: 4; background: #2d2d2d; color: #fff; padding: 20px; }
        
        input, select, textarea { width: 100%; margin-bottom: 10px; padding: 8px; box-sizing: border-box; }
        textarea { height: 300px; font-family: monospace; }
        label { font-weight: bold; font-size: 13px; color: #555; display: block; margin-top: 10px;}
        
        .btn { background: var(--primary); color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px; font-size: 16px; width: 100%; margin-top: 20px; }
        .btn:hover { background: #357abd; }

        .toolbar { background: #eee; padding: 5px; margin-bottom: 5px; display: flex; gap: 5px; }
        .tool-btn { cursor: pointer; padding: 2px 8px; background: white; border: 1px solid #ccc; }
        
        .info-box { background: #e3f2fd; padding: 10px; border-radius: 4px; font-size: 13px; color: #0d47a1; margin-bottom: 15px;}
        #logArea { font-family: monospace; color: #bbb; font-size: 12px; white-space: pre-wrap; }
    </style>
</head>
<body>

<div class="container">
    <div class="panel left">
        <h2>âœ¨ å…¨è‡ªåŠ¨åšå®¢æ–‡ç« ç”Ÿæˆ</h2>
        
        <div class="info-box" id="autoInfo">æ­£åœ¨è¯»å–æ•°æ®åº“...</div>

        <div style="display: flex; gap: 10px;">
            <div style="flex:1">
                <label>æ ‡é¢˜</label>
                <input type="text" id="title" placeholder="è¾“å…¥æ ‡é¢˜">
            </div>
            <div style="flex:1">
                <label>æ–‡ä»¶å (ä¾‹: 2025-11-06.html)</label>
                <input type="text" id="filename">
            </div>
        </div>

        <div style="display: flex; gap: 10px;">
            <div style="flex:1">
                <label>æ—¥æœŸ</label>
                <input type="date" id="date">
            </div>
            <div style="flex:1">
                <label>åˆ†ç±»</label>
                <input type="text" id="category" value="æ‚è°ˆ" onblur="checkCatPrev()">
            </div>
            <div style="flex:1">
                <label>ä½œè€…</label>
                <input type="text" id="author" value="Jiaqi Z.">
            </div>
        </div>

        <label>æ­£æ–‡å†…å®¹ (å¿«æ·é”®: Ctrl+B åŠ ç²—, Ctrl+K é“¾æ¥)</label>
        <div class="toolbar">
            <button class="tool-btn" onclick="fmt('b')">B</button>
            <button class="tool-btn" onclick="fmt('i')">I</button>
            <button class="tool-btn" onclick="fmt('p')">P</button>
            <button class="tool-btn" onclick="fmt('img')">Img</button>
        </div>
        <textarea id="contentBody"></textarea>

        <button class="btn" onclick="submitPost()">ğŸš€ ç”Ÿæˆæ–‡ä»¶å¹¶è‡ªåŠ¨æ›´æ–°ä¸Šä¸€ç¯‡</button>
    </div>

    <div class="panel right">
        <h3>ç³»ç»Ÿæ—¥å¿—</h3>
        <div id="logArea">ç­‰å¾…æ“ä½œ...</div>
    </div>
</div>

<script>
    let globalPrev = null;
    let catPrev = null;

    // åˆå§‹åŒ–ï¼šåŠ è½½æ•°æ®åº“
    window.onload = async () => {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date').value = today;
        document.getElementById('filename').value = today + '.html';

        try {
            const res = await fetch('/api/draft');
            const data = await res.json();
            globalPrev = data.globalPrev;
            updateInfoDisplay();
            // é»˜è®¤æ£€æŸ¥ä¸€ä¸‹åˆ†ç±»ä¸Šä¸€ç¯‡
            checkCatPrev();
        } catch (e) {
            log('æ— æ³•è¿æ¥æœåŠ¡å™¨ï¼Œè¯·ç¡®è®¤ server.js å·²å¯åŠ¨ã€‚');
        }
    }

    // æ£€æŸ¥åˆ†ç±»çš„ä¸Šä¸€ç¯‡
    async function checkCatPrev() {
        const cat = document.getElementById('category').value;
        const res = await fetch('/api/cat-prev', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ category: cat })
        });
        catPrev = await res.json();
        updateInfoDisplay();
    }

    function updateInfoDisplay() {
        let text = "";
        if (globalPrev) text += `âœ… æ£€æµ‹åˆ°ä¸Šä¸€ç¯‡ï¼š${globalPrev.title} (${globalPrev.filename})<br>`;
        else text += `âš ï¸ æš‚æ— ä¸Šä¸€ç¯‡è®°å½•ï¼ˆè¿™å°†æ˜¯ç¬¬ä¸€ç¯‡ï¼‰<br>`;

        if (catPrev) text += `âœ… åŒåˆ†ç±»ä¸Šä¸€ç¯‡ï¼š${catPrev.title} (${catPrev.filename})`;
        else text += `âš ï¸ æ­¤åˆ†ç±»æš‚æ— ä¸Šä¸€ç¯‡`;
        
        document.getElementById('autoInfo').innerHTML = text;
    }

    async function submitPost() {
        const payload = {
            title: document.getElementById('title').value,
            filename: document.getElementById('filename').value,
            date: document.getElementById('date').value,
            category: document.getElementById('category').value,
            author: document.getElementById('author').value,
            content: document.getElementById('contentBody').value,
            prevInfo: globalPrev,
            catPrevInfo: catPrev
        };

        if(!payload.title || !payload.content) return alert("æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©º");

        log("æ­£åœ¨æäº¤å¹¶å¤„ç†æ–‡ä»¶...");
        
        try {
            const res = await fetch('/api/create', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const result = await res.json();
            if (result.success) {
                log(`æˆåŠŸï¼\n${result.message}`);
                alert("ç”ŸæˆæˆåŠŸï¼");
                // åˆ·æ–°é¡µé¢ä»¥åŠ è½½æœ€æ–°çŠ¶æ€
                location.reload();
            } else {
                log("é”™è¯¯ï¼š" + JSON.stringify(result));
            }
        } catch (e) {
            log("è¯·æ±‚å¤±è´¥ï¼š" + e);
        }
    }

    // å·¥å…·å‡½æ•°
    function log(msg) { document.getElementById('logArea').innerText += '\n[' + new Date().toLocaleTimeString() + '] ' + msg; }
    
    // å¿«æ·é”®æ ¼å¼åŒ– (å’Œä¸Šä¸€ç‰ˆä¸€æ ·)
    const contentArea = document.getElementById('contentBody');
    contentArea.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            const map = {'b':'b', 'i':'i', 'p':'p', 'k':'a', 'm':'img'};
            if (map[e.key.toLowerCase()]) { e.preventDefault(); fmt(map[e.key.toLowerCase()]); }
        }
    });
    function fmt(type) {
        const start = contentArea.selectionStart;
        const end = contentArea.selectionEnd;
        const text = contentArea.value.substring(start, end);
        let replace = '';
        if(type==='b') replace = `<b>${text}</b>`;
        if(type==='i') replace = `<i>${text}</i>`;
        if(type==='p') replace = `<p>${text}</p>`;
        if(type==='a') replace = `<a href="#">${text||'é“¾æ¥'}</a>`;
        if(type==='img') replace = `<img src="" width="100%"/>`;
        contentArea.setRangeText(replace, start, end, 'select');
    }
</script>
</body>
</html>